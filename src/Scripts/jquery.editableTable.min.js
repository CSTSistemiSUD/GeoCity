(function(n){n.editableTable=function(t,i){function v(t){var h=n.Event("change"),s=r.html(),i,e,o;switch(t.type){case"dropdown":case"dropdownnamed":i=n("option:selected",u);r.html(i.text());break;case"dropdowngrouped":case"dropdowntwoarray":e=n("option:selected",u);o=e.closest("optgroup");i={optionGroup:o,option:e};r.html(e.text());break;default:i=u.val();r.html(i)}n.isFunction(f.settings.onChange)&&f.settings.onChange(r,t,i)===!1&&r.html(s)}var o=37,s=38,h=39,c=40,l=13,r,u,a={cssClass:"form-control input-sm",fields:[],cloneProperties:["padding","padding-top","padding-bottom","padding-left","padding-right","text-align","font","font-size","font-family","font-weight","border","border-top","border-bottom","border-left","border-right"],onChange:null},f=this,e,t;f.settings={};e=n(t);t=t;f.init=function(){f.settings=n.extend({},a,i);e.on("click dblclick",showEditor).keydown(function(t){var i=!0,r=movement(n(t.target),t.which);r.length>0?r.focus():t.which===l?showEditor(!1):t.which===17||t.which===91||t.which===93?(showEditor(!0),i=!1):i=!1;i&&(t.stopPropagation(),t.preventDefault())});e.on("keypress keyup blur",".allownumericwithoutdecimal",function(t){n(this).val(n(this).val().replace(/[^\d].+/,""));(t.which<48||t.which>57)&&t.preventDefault()})};movement=function(n,t){return t===h?n.next("td"):t===o?n.prev("td"):t===s?n.parent().prev().children().eq(n.index()):t===c?n.parent().next().children().eq(n.index()):[]};showEditor=function(t){var o,i,s;if(r=n(t.target),r.length&&(i=n.grep(f.settings.fields,function(n){return n.id===r.data("fieldId")})[0],i)){i.type=i.type||"text";switch(i.type){case"text":u=n('<input autocomplete="off">').val(r.text());break;case"allownumericwithdecimal":u=n('<input autocomplete="off">').on("keypress keyup blur",function(t){n(this).val(n(this).val().replace(/[^0-9\.]/g,""));(t.which!=46||n(this).val().indexOf(".")!=-1)&&(t.which<48||t.which>57)&&t.preventDefault()}).val(r.text());break;case"allownumericwithoutdecimal":u=n('<input autocomplete="off">').on("keypress keyup blur",function(t){n(this).val(n(this).val().replace(/[^\d].+/,""));(t.which<48||t.which>57)&&t.preventDefault()}).val(r.text());break;case"dropdown":i.datasource&&(u=n("<select>"),o=r.html(),n.isArray(i.datasource)&&(s=i.datasource),n.isFunction(i.datasource)&&(s=i.datasource(r)),n.each(s,function(t,i){u.append(n("<option>").val(i.value).text(i.text).prop("selected",o==i.text))}));break;case"dropdownnamed":i.datasource&&(u=n("<select>"),o=r.html(),n.isArray(i.datasource.options)&&n.each(i.datasource.options,function(t,r){u.append(n("<option>").val(r[i.datasource.value]).text(r[i.datasource.text]).prop("selected",o==r[i.datasource.text]))}));break;case"dropdowngrouped":i.datasource&&(u=n("<select>"),o=r.html(),n.isArray(i.datasource)&&n.each(i.datasource,function(t,i){var r=n("<optgroup>").attr({id:i.id,label:i.label});n.isArray(i.options)&&n.each(i.options,function(t,i){r.append(n("<option>").val(i.value).text(i.text).prop("selected",o==i.text))});u.append(r)}));break;case"dropdowntwoarray":i.datasource&&(u=n("<select>"),o=r.html(),n.isArray(i.datasource.optgroups.datasource)&&n.each(i.datasource.optgroups.datasource,function(t,r){var f=n("<optgroup>").attr({id:r[i.datasource.optgroups.value],label:r[i.datasource.optgroups.text]}),e;n.isArray(i.datasource.options)&&(e=n.grep(i.datasource.options,function(n){return n[i.datasource.group]===r[i.datasource.optgroups.value]}),n.each(e,function(t,r){f.append(n("<option>").val(r[i.datasource.value]).text(r[i.datasource.text]).prop("selected",o==r[i.datasource.text]))}));u.append(f)}))}u&&(u.addClass(f.settings.cssClass).css({position:"absolute"}).hide().appendTo(e.parent()),u.removeClass("error").show().offset(r.offset()).css(r.css(f.settings.cloneProperties)).width(r.width()).height(r.height()).focus().blur(function(){v(i);u.remove();u=null}))}};f.public_method=function(){};f.init()};n.fn.editableTable=function(t){return this.each(function(){if(undefined==n(this).data("editableTable")){var i=new n.editableTable(this,t);n(this).data("editableTable",i)}})}})(jQuery);