define([],function(){"use strict";function t(n,t,i,r,u,f,e){callWebMethod(ws_Catasto+"/CaricaImmobili",{p_PRJFOLDER:n,IDSogg:u,Foglio:t,Numero:i,TipoImmobili:r},function(n){var t=JSON.parse(n.d);t.ErrorMessage==""?$.isFunction(f)&&f(t):$.isFunction(e)&&e(t.ErrorMessage)})}function n(n,t,i,r,u){callWebMethod(ws_Catasto+"/DettaglioImmobile",{p_PRJFOLDER:n,IdImmobile:t,TipoImmobile:i,IndiceScheda:r},function(n){$.isFunction(u)&&u(n.d)})}function i(i,r){var u=i[0],f=i[1],e=i[2];BootstrapDialog.show({title:"Attendere prego...",message:$("<div><\/div>").load(app_url+"WebForms/Mappa/html/Catasto_Info.html?"+Math.random()),closable:!0,closeByBackdrop:!1,closeByKeyboard:!1,buttons:[{label:"Chiudi",action:function(n){n.close()}}],onshown:function(i){function h(n){$("#infoCatastoContent").html(n);c.hide();$("#divInfoCatasto").show()}var c=i.getModalContent().find("div.spinner"),o=$("#selIdentificativo"),s=1;o.change(function(){n(u,o.val(),r,s,h)});$("#infoCatastoTabs a").click(function(){s=$(this).data("index");n(u,o.val(),r,s,h)});t(u,f,e,r,"",function(t){var f=-1;if(t.ReturnDataset.PARTICELLE=t.ReturnDataset.PARTICELLE||[],t.ReturnDataset.FABBRICATI=t.ReturnDataset.FABBRICATI||[],t.ReturnDataset.PARTICELLE.length==0&&t.ReturnDataset.FABBRICATI.length==0)c.hide(),i.setTitle("Nessun risultato"),i.setMessage("Nessun risultato");else{switch(r){case app.enumLayers.PARTICELLE.name:f=t.ReturnDataset.PARTICELLE[0].idParticella;$.each(t.ReturnDataset.PARTICELLE,function(){o.append('<option value="'+this.idParticella+'">FG. '+this.foglio+" NUM. "+this.numero+"<\/option>")});$("#infoCatastoTab2").attr("aria-controls","Porzioni").html("Porzioni");break;case app.enumLayers.FABBRICATI.name:f=t.ReturnDataset.FABBRICATI[0].idImmobile;$.each(t.ReturnDataset.FABBRICATI,function(){o.append('<option value="'+this.idImmobile+'">FG. '+this.foglio+" NUM. "+this.numero+" SUB "+this.subalterno+"<\/option>")});$("#infoCatastoTab2").attr("aria-controls","Identificativi").html("Identificativi")}i.setTitle(r);n(u,f,r,s,h)}},function(n){i.setTitle("Errore");i.setMessage('<div class="alert alert-danger" role="alert">'+n+"<\/div>")})}})}function r(){var i,n,r;callWebMethod(ws_Catasto+"/InfoAggiornamento",{p_PRJFOLDER:_codice,testo:""},function(u){var f=JSON.parse(u.d),e=[];f.ErrorMessage==""&&$.each(f.DataTable,function(){var n=$("<p>");n.append("Esportazione: <strong>"+this.descrizione+"<\/strong> (num. record: "+this.numRecord+", data selezione: "+this.dataSelezione+", data elaborazione: "+this.dataElaborazione+", periodo: "+this.periodo+")");e.push(n)});BootstrapDialog.show({title:"Ricerca titolarit√†",message:$("<div><\/div>").load(app_url+"WebForms/Mappa/html/Catasto_Ricerca.html?"+Math.random()),size:BootstrapDialog.SIZE_WIDE,closable:!0,closeByBackdrop:!1,closeByKeyboard:!1,buttons:[{label:"Riduci",cssClass:"btn-warning",action:function(){$(this).html()=="Riduci"?$(this).html("Espandi"):$(this).html("Riduci");r.toggle()}},{label:"Chiudi",action:function(n){n.close()}}],onshown:function(u){i=u.getModalContent().find('[data-id="btnShowInfo"]');n=u.getModalContent().find('[data-id="dialogInfo"]');r=u.getModalContent().find('[data-id="dialogContent"]');i.click(function(){n.toggle()});$.each(e,function(){n.append(this)});$("#btnRicercaCatasto").click(function(){$("#txtRicercaCatasto").val()!=""&&($("#tblRicercaCatasto").empty(),callWebMethod(ws_Catasto+"/RicercaTitolari",{p_PRJFOLDER:_codice,testo:$("#txtRicercaCatasto").val()},function(n){var t=JSON.parse(n.d);t.ErrorMessage==""?$("#tblRicercaCatasto").append($("#tmplRigaRicercaCatasto").render(t.DataTable)):alertDanger(t.ErrorMessage)}))});u.getModalContent().on("click","a.toggle-next-row",function(){var n=$(this),r=n.attr("data-id"),u=n.closest("tr"),i=u.next("tr"),f=i.children("td").find(".risultati");i.is(":visible")?(i.hide(),n.html('<span class="glyphicon glyphicon-triangle-right"><\/span>')):(i.show(),n.html('<span class="glyphicon glyphicon-triangle-bottom"><\/span>'),t(_codice,"","","",r,function(n){n.ErrorMessage==""?f.empty().append($("#tmplTabelleImmobili").render(n.ReturnDataset)):alertDanger(n.ErrorMessage)}))})}})})}return{inizializza:function(){var n=$('<button type="button" class="btn btn-sm btn-default"><span class="glyphicon glyphicon-folder-close"><\/span> Catasto<\/button>');n.click(function(){r()});$(app.mainToolbar).prepend(n);$(document).on("click","button.btn-info-catasto, button.btn-zoom-catasto",function(){var r=$(this).data("terna"),t=$(this).data("livello"),n=r.split("|");if($(this).hasClass("btn-info-catasto"))i(n,t);else if($(this).hasClass("btn-zoom-catasto")){var u=n[1].replace(/^0+/,""),f=n[2].replace(/^0+/,""),e=" foglio = '"+u.trim()+"' AND numero = '"+f.trim()+"'",o=t==app.enumLayers.FABBRICATI.name?app.enumLayers.FABBRICATI.id:app.enumLayers.PARTICELLE.id;app.queryFeatures(o,e,function(n){app.zoomToFeatures("",n);app.highlightFeatures(n)})}})}}});