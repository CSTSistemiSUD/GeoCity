define(["esri/request","esri/graphicsUtils","esri/graphic","esri/symbols/SimpleFillSymbol","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","esri/tasks/Geoprocessor","dojo/_base/array","dojo/on"],function(n,t,i,r,u,f,e,o,s,h){"use strict";function bt(){function i(n){if(ht=new u(d,{async:!0}),ut=new o(d),ft=s.filter(n.parameters,function(n){return n.name==="Layout_Template"}),ft.length===0){console.log('print service parameters name for templates must be "Layout_Template"');return}if(b=ft[0].choiceList,g=s.indexOf(b,"MAP_ONLY"),g>-1){var t=b.splice(g,g+1)[0];b.push(t)}ct=s.map(b,function(n){var t=new e;return t.layout=t.label=n,t.format="PDF",t.layoutOptions={},t});lt=s.map(ct,function(n){var t=new f;return t.map=app.map,t.template=n,t});console.log("Geoprocessor ok")}d=app.ags_services_url+"/"+_servizio+"/GPServer/Export%20Web%20Map";var t=n({url:d,content:{f:"json"}});t.then(i,function(n){console.log("Something broke: ",n)})}function kt(n,t){ut.submitJob(n,function(n){ut.getResultData(n.jobId,"Output_File",function(i){t({jobId:n.jobId,status:1,message:i.value.url,percentage:100})},function(i){t({jobId:n.jobId,status:-1,message:i,percentage:100})})},function(n){switch(n.jobStatus){case"esriJobSubmitted":t({jobId:n.jobId,status:0,message:"Avvio processo di esportazione...",percentage:25});break;case"esriJobExecuting":t({jobId:n.jobId,status:0,message:"Esportazione...",percentage:50});break;case"esriJobSucceeded":t({jobId:n.jobId,status:0,message:"Esportazione completata con successo",percentage:100});break;case"esriJobFailed":t({jobId:n.jobId,status:0,message:"Esportazione fallita",percentage:100})}},function(n){t({jobId:-1,status:-1,message:n,percentage:100})})}function dt(){ot=new esri.tasks.IdentifyTask(app.operationalMap.url);v=new esri.tasks.IdentifyParameters;v.tolerance=0;v.returnGeometry=!0;v.layerOption=esri.tasks.IdentifyParameters.LAYER_OPTION_ALL;v.width=app.map.width;v.height=app.map.height;v.layerIds=[]}function gt(){k=$("<div>").sidebar();app.mapContainer.append(k);tt=k.data("bs.sidebar");var n=$($("#tmplPanelButton").render({Id:"VINCOLI",Title:"VINCOLI",Icon:"glyphicon glyphicon-leaf",Label:"VINCOLI"}));n.removeClass("toggle-panel").removeAttr("data-target").click(function(){tt.show()});$(app.mainToolbar).append(n)}function ni(n,t){for(var i,f,e,r,o,s,h,c=$.templates('<tr><td style="vertical-align:top; padding-left:5px;"><input type="checkbox" class="check_vincolo" data-id="{{:layer.id}}" /><\/td><td style="vertical-align:top; padding-left:5px;">{{:layer.name}}<\/td><\/tr>'),u=0;u<t.length;u++)i=t[u],i.parentLayerId==n&&(v.layerIds.push(i.id),nt.push({layer:i,title:i.name}));p=app.visibleLayers.slice();nt.sort(function(n,t){var i=n.layer.name.toUpperCase(),r=t.layer.name.toUpperCase();return i>r?1:r>i?-1:0});f=$("<table>");e=$("<tbody>");f.append(e);$.each(nt,function(){e.append(c.render(this))});r=$('<div style="position:fixed; bottom: 0;overflow:auto; top: 110px; margin-bottom: 50px; width:275px; background-color: #fff; border: 1px solid #eee;">');f.appendTo(r);o=$('<button type="button" class="btn btn-success btn-sm" style="margin-right:5px;">Aggiorna Mappa<\/button>');o.click(function(){event.preventDefault();var n=p.slice();app.visibleLayersVincoli=[];r.find(".check_vincolo:checked").each(function(){n.push($(this).data("id"));app.visibleLayersVincoli.push($(this).data("id"))});$.each(app.visibleLayersBase,function(t,i){n.push(i)});app.operationalMap.setVisibleLayers(n);app.legend.refresh()});s=$('<button type="button" class="btn btn-danger btn-sm" style="margin-right:5px;">Spegni tutto<\/button>');s.click(function(){event.preventDefault();r.find(".check_vincolo").each(function(){$(this).prop("checked",!1)});var n=app.operationalMap.visibleLayers.slice();app.operationalMap.setVisibleLayers(n);app.legend.refresh()});h=$("<div>");h.append(o).append(s).append(r);tt.setContent("<p>VINCOLI<br/><small>",h);k.on("show.bs.sidebar",function(){})}function at(n,t){var i=new esri.tasks.Query,r,u;i.objectIds=[t];i.outFields=["FOGLIO, NUMERO, RICERCA"];i.returnGeometry=!0;r=n==app.enumLayers.FABBRICATI.name?app.enumLayers.FABBRICATI.id:app.enumLayers.PARTICELLE.id;u=new esri.tasks.QueryTask(app.operationalMap.url+"/"+r);u.execute(i,function(t){t.features.length>0&&ti(n,t.features[0])})}function ti(n,t){l=[];BootstrapDialog.show({title:"ANALISI IN CORSO...",message:$("<div><\/div>").load(app_url+"WebForms/Mappa/html/Vincoli.html?"+Math.random()),closable:!0,closeByBackdrop:!1,closeByKeyboard:!1,onshown:function(i){function u(){var n=app.map.getScale();return parseInt(n)}var o=i.getModalContent().find("div.spinner"),w=i.getModalContent().find("tbody"),b=i.getModalContent().find("div.export-options"),k=i.getModalContent().find("button.button-export"),d=i.getModalContent().find("button.button-close"),f=i.getModalContent().find("select.select-extent"),r=i.getModalContent().find("select.select-layout"),e=i.getModalContent().find("input.current-scale");e.val(u()).blur(function(){parseFloat(this.value)>0?this.value!=u()&&app.zoomToScale(this.value):this.value=u()});rt?s.forEach(lt,function(n){r.append($("<option>").data("Params",n).val(n.template.label).text(n.template.label))}):$.each(st,function(n,t){r.append($("<option>").val(t.value).text(t.label))});k.click(function(){var u;if(i.close(),yt=0,rt){if(l.length>0){var o=r.find("option:selected").data("Params"),s="LIVELLO: "+n+" FOGLIO: "+t.attributes.FOGLIO+" NUMERO: "+t.attributes.NUMERO;a(c.Start,"Preparazione mappa...");y=0;it=0;vt(f.val(),e.val(),n,t.attributes.FOGLIO,t.attributes.NUMERO,o,s,96)}}else{var v=f.val(),w=150,b=r.val().split("|"),k=$("option:selected",r).text(),d=app.getPageSize(b,k);l.length>0&&(a(c.Start,"Preparazione mappa..."),u=h(app.operationalMap,"update-end",function(){u.remove();et(0,v,w,d,n,t.attributes.FOGLIO,t.attributes.NUMERO)}),app.operationalMap.setVisibleLayers(p))}});d.click(function(){i.close()});v.geometry=t.geometry;v.mapExtent=app.map.extent;ot.execute(v,function(r){for(var f=[],u=0,e=r.length;u<e;u++)$.inArray(r[u].layerName,f)===-1&&(l.push({layerId:r[u].layerId,layerName:r[u].layerName,legend:app.getLayerLegend(r[u].layerId),exportResult:null}),f.push(r[u].layerName),w.append($("<tr>").append($("<td>").html(r[u].layerName))));i.setTitle("<p><strong>"+n+": "+t.attributes.RICERCA+" ELENCO VINCOLI: "+l.length+"<\/strong> RISULTATI<\/p>");b.show();o.hide()})}})}function vt(n,t,i,r,u,f,e,o){var h,v,s,b,w,k;y<l.length?(a(c.Process,l[y].layerName+"..."),h=p.slice(),v=l[y].layerId,h.push(parseInt(v)),s=ii(f,e,o),s.operationalLayers[0].visibleLayers=h.sort().slice(),s.layoutOptions.legendOptions.operationalLayers.push({id:s.operationalLayers[0].id,sublayerIds:[v]}),n=="CURRENT_SCALE"&&(s.mapOptions.scale=parseFloat(t)),b={Web_Map_as_JSON:JSON.stringify(s),Format:"PDF",Layout_Template:f.template.layout},kt(b,function(s){switch(s.status){case 1:l[y].exportResult=s;l[y].errorMessage="";break;case-1:it+=1;l[y].errorMessage=l[y].layerName+": "+s.message}s.status!=0&&(y+=1,vt(n,t,i,r,u,f,e,o))})):it==0?(a(c.Process,"Generazione report..."),w=[],$.each(l,function(n,t){t.errorMessage==""&&w.push(t.exportResult)}),k={Servizio:_servizio,CodiceComune:_codice,Livello:i,Foglio:r,Numero:u,Jobs:w.slice()},callWebMethod(page_Url+"/CombinePDFFile",k,function(n){a(c.Success,n.d);setTimeout(function(){location.href=n.d},250)},function(n){a(c.Error,n)},function(){})):a(c.Error,"Impossibile completare")}function ii(n,t,i){var r=ht._getPrintDefinition(app.map,n);return r.layoutOptions={titleText:t,authorText:"GeoSafety",copyrightText:"Â© "+(new Date).getFullYear()+" GeoSafety s.r.l.",scaleBarOptions:{metricUnit:"meters",metricLabel:"m"},legendOptions:{operationalLayers:[]}},r.exportOptions={dpi:i,outputSize:[500,500]},r}function et(n,t,i,r,u,f,e){var o="",s,y,v,w;n<l.length?(a(c.Process,l[n].layerName+"..."),s=p.slice(),s.push(l[n].layerId),y=h(app.operationalMap,"update-end",function(){y.remove();app.exportLayoutClient(t,r,i,function(s){s.ERROR_MESSAGE==""?(l[n].exportResult=s,et(n+1,t,i,r,u,f,e)):(o=s.ERROR_MESSAGE,et(l.length,t,i,r,u,f,e))})}),app.operationalMap.setVisibleLayers(s)):(o==""?(a(c.Process,"Generazione report..."),v=[],$.each(l,function(n,t){v.push({Titolo:t.layerName,Immagine:t.exportResult.EXPORTED_IMAGE,Legenda:t.legend})}),w={CodiceComune:_codice,Livello:u,Foglio:f,Numero:e,Servizio:_servizio,PaginaTipo:r.Id,PaginaOrientamento:r.Orientation,PaginaLarghezza:r.Xmm,PaginaAltezza:r.Ymm,Template:r.FileName,ImmaginiEsportate:v.slice()},callWebMethod(page_Url+"/CreaReportVincoli",w,function(n){a(c.Success,n.d);setTimeout(function(){location.href=n.d},250)},function(n){a(c.Error,n)},function(){})):a(c.Error,o),basemap.setVisibleLayers(p))}function a(n,t){if(wt!=n)switch(n){case c.Start:w=BootstrapDialog.show({title:"Attendere il completamento...",message:$("<div><\/div>").load(app_url+"WebForms/Mappa/html/MultipleExportDialog.html"),closable:!1,closeByBackdrop:!1,closeByKeyboard:!1,buttons:[{id:"closeWaitDialog",label:"Chiudi",action:function(n){n.close()}}],onshown:function(n){$("#MultipleExportStatusMessage").removeClass().addClass("text-info").empty();$("#MultipleExportLoader").show();n.getButton("closeWaitDialog").disable()}});break;case c.Error:$("#MultipleExportStatusMessage").removeClass().addClass("text-danger").empty();$("#MultipleExportLoader").hide();w.setTitle("Operazione completata");w.getButton("closeWaitDialog").enable();break;case c.Success:$("#MultipleExportStatusMessage").removeClass().addClass("text-success").empty();$("#MultipleExportLoader").hide();w.setTitle("Operazione completata");w.getButton("closeWaitDialog").enable()}n==c.Success?$("#MultipleExportStatusMessage").html('<a href="'+t+'" target="_blank" style="font-size:10pt;"><span class="glyphicon glyphicon-download-alt"><\/span>Scarica il file PDF<\/a>'):$("#MultipleExportStatusMessage").html(t)}function ri(n,t){a(c.Start,"Preparazione mappa...");var r=t.split("|"),u=n,i=app.getPageSize(r,u);app.exportLayoutClient(app.exportExtent.CURRENT_SCALE,i,150,function(n){var r,t,u,f;for(a(c.Process,"Generazione report..."),r={layers:[]},t=0;t<app.operationalMap.visibleLayers.length;t++)u=app.operationalMap.visibleLayers[t],$.each(app.operationalMapLegend.layers,function(n,t){if(t.layerId==u)return r.layers.push(t),!1});f={CodiceComune:_codice,Servizio:_servizio,PaginaTipo:i.Id,PaginaOrientamento:i.Orientation,PaginaLarghezza:i.Xmm,PaginaAltezza:i.Ymm,Template:i.FileName,Immagine:n.EXPORTED_IMAGE,Livelli:r};callWebMethod(page_Url+"/EsportaStralcio",f,function(n){a(c.Success,n.d);setTimeout(function(){location.href=n.d},250)},function(n){a(c.Error,n)},function(){})})}var nt=[],p=[],l=[],yt=0,ot=null,v=null,st=null,tt=null,k=null,pt=new r({style:"none",outline:{width:2,style:"solid",color:{r:0,g:255,b:255,a:1}},color:{r:0,g:0,b:0,a:0}}),wt,c={Start:0,Process:1,Error:2,Success:3},w=null,y=0,it=0,rt=!0,d="",ht,ut,ft,b,g,ct,lt;return{inizializza:function(n,t){rt?bt():st=JSON.parse(_layouts);dt();gt();ni(n,t);$(document).on("click","button.btn-analizza-vincoli",function(){var n=$(this).data("oid"),t=$(this).data("livello");at(t,n)});$(document).on("click","a.export-map",function(){ri($(this).data("label"),$(this).data("layout"))})},analizza:function(n,r){var u=n==app.enumLayers.FABBRICATI.name?app.enumLayers.FABBRICATI.id:app.enumLayers.PARTICELLE.id;app.queryIds(u,[r],function(u){app.map.graphics.add(new i(u[0].geometry,pt));var f=app.map.setExtent(t.graphicsExtent(u).expand(2));f.then(function(){at(n,r)})})}}});