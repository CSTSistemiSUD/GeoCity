define(["esri/graphicsUtils","esri/graphic","esri/symbols/SimpleFillSymbol","dojo/on"],function(){"use strict";function o(){i=$("<div>").sidebar();app.mapContainer.append(i);n=i.data("bs.sidebar");var t=$($("#tmplPanelButton").render({Id:"SUED",Title:"SUED",Icon:"glyphicon glyphicon-briefcase",Label:"SUED"}));t.removeClass("toggle-panel").removeAttr("data-target").click(function(){n.show()});$(app.mainToolbar).append(t)}function s(){u=$.templates('<table class="table-info">\t<tbody>\t<tr><td class="field-label">SIGLATIPODOC<\/td><td>{{:SIGLATIPODOC}}<\/td><\/tr>\t<tr><td class="field-label">numero_protocollo<\/td><td>{{:numero_protocollo}}<\/td><\/tr>\t<tr><td class="field-label">data_protocollo<\/td><td>{{:data_protocollo}}<\/td><\/tr>\t<tr><td class="field-label">num_pratica<\/td><td>{{:num_pratica}}<\/td><\/tr>\t<tr><td class="field-label">statopratica<\/td><td>{{:statopratica}}<\/td><\/tr>\t<tr><td class="field-label">tipologia<\/td><td>{{:tipologia}}<\/td><\/tr>\t<tr><td class="field-label">richiedente<\/td><td>{{:richiedente}}<\/td><\/tr>\t<tr><td class="field-label">altri_richiedenti<\/td><td>{{:altri_richiedenti}}<\/td><\/tr>\t<tr><td class="field-label">responsabile_proced<\/td><td>{{:responsabile_proced}}<\/td><\/tr>\t<tr><td class="field-label">oggetto<\/td><td>{{:oggetto}}<\/td><\/tr>\t<tr><td class="field-label">tipologia_procedime<\/td><td>{{:tipologia_procedime}}<\/td><\/tr>\t<tr><td class="field-label">localita<\/td><td>{{:localita}}<\/td><\/tr>\t<tr><td class="field-label">impresa<\/td><td>{{:impresa}}<\/td><\/tr>\t<tr><td class="field-label">progettista<\/td><td>{{:progettista}}<\/td><\/tr>\t<tr><td class="field-label">diretore_lavori<\/td><td>{{:diretore_lavori}}<\/td><\/tr>\t<tr><td class="field-label">resp_sicurezza<\/td><td>{{:resp_sicurezza}}<\/td><\/tr>\t<tr><td class="field-label">collaudatore<\/td><td>{{:collaudatore}}<\/td><\/tr>\t<tr><td class="field-label">foglio<\/td><td>{{:foglio}}<\/td><\/tr>\t<tr><td class="field-label">particella<\/td><td>{{:particella}}<\/td><\/tr>\t<tr><td class="field-label">sub<\/td><td>{{:sub}}<\/td><\/tr>\t<tr><td class="field-label">sup_asservita<\/td><td>{{:sup_asservita}}<\/td><\/tr>\t<tr><td class="field-label">sup_catastale<\/td><td>{{:sup_catastale}}<\/td><\/tr>\t<tr><td class="field-label">classe<\/td><td>{{:classe}}<\/td><\/tr>\t<tr><td class="field-label">rendita<\/td><td>{{:rendita}}<\/td><\/tr>\t<tr><td class="field-label">tarsu<\/td><td>{{:tarsu}}<\/td><\/tr>\t<tr><td class="field-label">definitivo<\/td><td>{{:definitivo}}<\/td><\/tr>\t<tr><td class="field-label">note<\/td><td>{{:note}}<\/td><\/tr>\t<\/tbody><\/table><hr/>');f=$.templates('<tr><td  style="padding-bottom: 2px; padding-right:1rem;">\t<button type="button" class="btn btn-sm btn-primary zoom-particella" data-foglio="{{:foglio}}" data-particella="{{:particella}}"><span class="glyphicon glyphicon-search"><\/span><\/button><\/td><td style="padding-right:1rem;">Fg. {{:foglio}} n. {{:particella}}<\/td><td><small>{{:valore}}<\/small><\/td><\/tr>')}function h(){$(document).on("click","button.btn-info-sued",function(){var t=$(this).data("terna"),i=$(this).data("livello"),n=t.split("|");callWebMethod(page_Url+"/SUED_EstraiInfo",{Comune:n[0],Foglio:n[1],Numero:n[2]},function(n){var t=JSON.parse(n.d),i;t.ErrorMessage!=""?BootstrapDialog.alert(t.ErrorMessage):(i=$('<div style="max-height:350px;overflow:auto;">'),$.each(t.DataTable,function(){i.append(u.render(this))}),BootstrapDialog.show({title:"NR PRATICHE "+t.DataTable.length,message:i,buttons:[{label:"Chiudi",action:function(n){n.close()}}]}))})})}function c(i,u){function v(){var n=r.slice(),t=s.val();t!=""&&n.push(parseInt(t));app.operationalMap.setVisibleLayers(n);app.legend.refresh()}function y(){c.empty();var n=s.find("option:selected").text();n!="NESSUNO"&&callWebMethod(page_Url+"/SUED_EstraiParticelle",{LIVELLO_PE:n},function(n){var t=JSON.parse(n.d),i,r;t.ErrorMessage!=""?c.append('<p class="text-danger">'+t.ErrorMessage+"<\/p>"):(i=$('<table class="table table-condensed table-bordered searchable">'),r=$("<tbody>"),i.append(r),$.each(t.DataTable,function(){r.append(f.render(this))}),c.append(i))})}for(var h,o,s,a,c,l=0;l<u.length;l++)h=u[l],h.parentLayerId==i&&(e=h.parentLayerId,t.push({layer:h,title:h.name}));r=app.visibleLayers.slice();t.sort(function(n,t){var i=n.layer.name.toUpperCase(),r=t.layer.name.toUpperCase();return i>r?1:r>i?-1:0});o=$('<div class="form-group">');o.append('<label class="small">SELEZIONA LIVELLO DA VISUALIZZARE<\/label>');s=$('<select class="form-control input-sm select-layer">');s.append('<option value="">NESSUNO<\/option>').change(function(){v();y()});$.each(t,function(){s.append('<option value="'+this.layer.id+'">'+this.layer.name+"<\/option>")});o.append(s);$.fn.delayBind=function(n,t,i,r){$.isFunction(t)&&(r=i,i=t,t=undefined);var f=this,u=null,e=function(n){clearTimeout(u);u=setTimeout(function(){i.apply(f,[$.extend({},n)])},r)};return this.bind(n,t,e)};a=$('<input type="text" class="form-control input-sm searchBox" placeholder="Ricerca libera..." title="Filtra" style="margin:0.5em 0" />');a.delayBind("keyup",function(){var n=$(this).val().toLowerCase().split(" ");$("tbody tr",".searchable").each(function(){var i=$(this).html().toLowerCase().replace(/<.+?>/g,"").replace(/\s+/g," "),t=0;$.each(n,function(){if(i.indexOf(this)<0)return t=1,!1});t?$(this).hide():$(this).show()})},300);o.append(a);c=$('<div style="position:fixed; bottom: 0;overflow:auto; top: 190px; margin-bottom: 50px; width:275px; background-color: #fff; border: 1px solid #eee;">');o.append(c);n.setContent("<p>SUED<br/><small>Aggiornato il "+_sued_last_update+"<\/small><\/p>",o);o.on("click",".zoom-particella",function(){var n=" foglio = '"+$(this).data("foglio").trim()+"' AND numero = '"+$(this).data("particella").trim()+"'";app.queryFeatures(app.enumLayers.PARTICELLE.id,n,function(n){app.zoomToFeatures("",n);app.highlightFeatures(n)})})}var e=-1,t=[],r=[],l=$('<button type="button" class="btn btn-success btn-sm">Aggiorna Mappa<\/button>'),u,f,i=null,n=null;return{inizializza:function(n,t){o();s();h();c(n,t)},apriToc:function(){n.show()}}});