define(["esri/map","esri/arcgis/utils","esri/geometry/Point","dojo/_base/declare","dojo/on","dojo/touch","dojo/dom","dojo/_base/lang","dojo/dom-style","dojo/query","dojo/NodeList-traverse","dojo/dom-class","dojo/domReady!"],function(n,t,i,r,u,f,e,o,s,h,c,l){"use strict";return{create:function(n,t){var i,r;if(n&&t)return i=new this._smartResizer(n,t),r=i.createMap(),r._smartResizer=i,r},createWebMap:function(n,t,i){var r;if(t&&i)return r=new this._smartResizer(t,i),r.createWebMap(n)},destroy:function(n){function t(n){if(n._handles)for(var t=n._handles.length;t--;)n._handles[t].remove(),n._handles.splice(t,1)}n&&n._smartResizer&&t(n._smartResizer)},_smartResizer:r(null,{constructor:function(n,t){this._map=null;this._autoRecenterDelay=50;this._popupRecenterDelayer=150;this._popupPosition="top";this._popupBlocked=!1;this._visible=!0;this._visibilityTimer=null;this._mapDeferred=null;this._autoRecenter=t.autoRecenter||!0;this._responsiveResize=t.responsiveResize||!0;this._mapDivId=n;this._mapDiv=e.byId(n);this._mapStyle=s.get(this._mapDiv);this._options=o.mixin(t,{});this._handles=[]},createMap:function(){return this._setMapDiv(!1),this._responsiveResize&&o.mixin(this._options,{smartNavigation:!1,autoResize:!1}),this._map=new n(this._mapDivId,this._options),this._setPopup(),this._bindEvents(),this._mapDiv.__map=this._map,this._map},createWebMap:function(n){var i,r,u;return this._setMapDiv(!1),this._options.hasOwnProperty("mapOptions")||(this._options.mapOptions={}),this._responsiveResize&&o.mixin(this._options.mapOptions,{smartNavigation:!1,autoResize:!1}),i=t.createMap(n,this._mapDivId,this._options),this._mapDeferred=i,r=this,u=function(n){this._map=n.map;this._setPopup();this._bindEvents();this._mapDiv.__map=this._map;this._smartResizer=r;this._smartResizer._setMapDiv(!0);this._map._smartResizer=this._smartResizer},this._mapDeferred.then(o.hitch(this,u)),i},_setPopup:function(){l.add(this._map.infoWindow.domNode,"light")},_setTouchBehavior:function(){this._options.hasOwnProperty("scrollWheelZoom")?this._options.scrollWheelZoom?this._map.enableScrollWheelZoom():this._map.disableScrollWheelZoom():this._map.disableScrollWheelZoom();u(h(".esriPopup .titleButton.close"),f.press,o.hitch(this,function(){this._map.infoWindow.hide()}))},_bindEvents:function(){var t,i,r,n,f,e,s;if(!this._map){console.error("BootstrapMap: Invalid map object. Please check map reference.");return}t=function(){this._setTouchBehavior()};this._map.loaded?o.hitch(this,t).call():this._handles.push(u(this._map,"load",o.hitch(this,t)));i=function(){this._map.infoWindow.anchor=this._popupPosition;var n=function(n){var t=n._map.infoWindow.location;t&&!n._popupBlocked&&(n._popupBlocked=!0,window.setTimeout(function(){n._repositionMapForInfoWin(t);n._popupBlocked=!1},n._popupRecenterDelayer))};this.counter=0;this._map.on("click",o.hitch(this,function(){this._map.infoWindow.isShowing&&n(this)}));u(this._map.graphics,"click",o.hitch(this,function(){n(this)}));u(this._map.infoWindow,"show",o.hitch(this,function(){n(this)}))};this._map.loaded?o.hitch(this,i).call():this._handles.push(u(this._map,"load",o.hitch(this,i)));r=function(t,i,r){return function(){function e(){r||t.apply(u,f);n=null}var u=this,f=arguments;n?clearTimeout(n):r&&t.apply(u,f);n=setTimeout(e,i||100)}};f=r(this._setMapDiv,100,!1);this._handles.push(u(window,"resize",o.hitch(this,f)));this._autoRecenter&&(e=function(){this._map.__resizeCenter=this._map.extent.getCenter();s=function(){this._map.centerAt(this._map.__resizeCenter)};setTimeout(o.hitch(this,s),this._autoRecenterDelay)},this._handles.push(u(this._map,"resize",o.hitch(this,e))))},_getMapDivVisibility:function(){return this._mapDiv.clientHeight>0||this._mapDiv.clientWidth>0},_checkVisibility:function(){var n=this._getMapDivVisibility();this._visible!==n&&n&&this._setMapDiv(!0)},_controlVisibilityTimer:function(n){n?this._visibilityTimer=setInterval(o.hitch(this,function(){this._checkVisibility()}),200):this._visibilityTimer&&(clearInterval(this._visibilityTimer),this._visibilityTimer=null)},_setMapDiv:function(n){if(this._mapDivId&&this._responsiveResize){var i,h,c,r,u,t,e,f,o;i=this._getMapDivVisibility();this._visible!==i&&(this._visible=i,this._controlVisibilityTimer(!i));this._visible&&(h=document.documentElement.clientHeight,c=document.body.clientHeight,r=h-c,u=this._calcMapHeight(),t=this._calcColumnHeight(u),e=u+r,f=0,o=!1,u<t?(f=r>0?t+r:t,o=!0):(f=e<t?t:e,o=!1),s.set(this._mapDivId,{height:f+"px",width:"auto"}),this._map&&n&&this._visible&&(this._map.resize(),this._map.reposition()))}},_calcMapHeight:function(){var n=this._mapStyle,t=parseInt(n.paddingTop,10)+parseInt(n.paddingBottom,10)||0,i=parseInt(n.marginTop,10)+parseInt(n.marginBottom,10)||0,r=parseInt(n.borderTopWidth,10)+parseInt(n.borderBottomWidth,10)||0;return t+i+r+this._mapDiv.clientHeight},_calcColumnHeight:function(){var n,t,i=0,r=h(this._mapDiv).closest(".row").children("[class*='col']"),u;if(r.length)for(n=0;n<r.length;n++)t=r[n],u=h("#"+this._mapDivId,t).length>0,t.clientHeight>i&&!u&&(i=t.clientHeight);return i},_repositionMapForInfoWin:function(n){var w=new i(this._map.extent.xmax,this._map.extent.ymax,this._map.spatialReference),u=new i(this._map.extent.getCenter()),o=this._map.toScreen(w),r=this._map.toScreen(u),f=this._map.toScreen(n),t=10,s=3,h=this._map.infoWindow.domNode.childNodes[0],c=h.clientWidth,b=h.clientHeight+this._map.infoWindow.marginTop,e=f.x-c/2,l=f.x+c/2,a=e-t<0,v=l>o.x-t,k=this._map.infoWindow.offsetY,y=f.y-b-k,p=y-s<0;a?r.x-=Math.abs(e)+t<t?t:Math.abs(e)+t:v&&(r.x+=l-o.x+t);p&&(r.y+=y-s);(v||a||p)&&(u=this._map.toMap(r),this._map.centerAt(u))}})}});