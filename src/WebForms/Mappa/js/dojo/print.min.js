define(["esri/request","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","esri/tasks/Geoprocessor","esri/tasks/LegendLayer","dojo/_base/array","dojo/domReady!"],function(n,t,i,r,u,f,e){function s(n){var t="";t+='<table class="fields">';t+="     <tbody>";t+="         <tr>";t+='             <td class="field-label">Titolo<\/td>';t+='             <td><input type="text" class="printOptionsTitle form-control input-sm" placeholder="Titolo"><\/td>';t+="         <\/tr>";t+="         <tr>";t+='             <td class="field-label">Risoluzione<\/td>';t+="             <td>";t+='                 <select class="printOptionsDpi form-control input-sm">';t+='                     <option value="96" selected>96 DPI<\/option>';t+='                     <option value="150">150 DPI<\/option>';t+='                     <option value="300">300 DPI<\/option>';t+="                 <\/select>";t+="             <\/td>";t+="         <\/tr>";t+="         <tr>";t+='              <td class="field-label">Template<\/td>';t+='              <td><select class="printOptionsLayoutTemplate form-control input-sm"><\/select><\/td>';t+="         <\/tr>";t+="     <\/tbody>";t+=" <table>";t+=" <hr />";t+=' <div class="text-center">';t+='     <a href="#"  class="printBtn btn btn-primary btn-sm"><span class="glyphicon glyphicon-print"><\/span> Esporta<\/a>';t+=" <\/div>";t+=" <br />";t+=' <div class="printProcess"><\/div>';$(n).append(t);o.printOptionsTitle=$(n).find(".printOptionsTitle").eq(0);o.printOptionsDpi=$(n).find(".printOptionsDpi").eq(0);o.printOptionsLayoutTemplate=$(n).find(".printOptionsLayoutTemplate").eq(0);o.printBtn=$(n).find(".printBtn").eq(0);o.printProcess=$(n).find(".printProcess").eq(0)}function h(n){function v(n,t,r){function u(n,t,i){o.waitProgress.animate({width:t+"%"},500,function(){o.waitMessage.empty().append(n)});t==100&&(i?o.waitProgress.removeClass("progress-bar-info").addClass("progress-bar-danger"):o.waitProgress.removeClass("progress-bar-info").addClass("progress-bar-success"))}function f(){o.printBtn.prop("disabled",!1)}function h(){o.printBtn.prop("disabled",!0)}function l(n,t,r){var e=new i,u,f;return e.map=app.map,e.template=n,u=a._getPrintDefinition(app.map,e),f=[],$.each(app.map.layerIds,function(n,t){if(o.legendLayerIds.indexOf(t)<0)f.push({id:t,subLayerIds:[]});else{var i=app.map.getLayer(t);f.push({id:t,subLayerIds:i.visibleLayers.slice()})}}),u.layoutOptions={titleText:t,authorText:o.options.authorText,copyrightText:o.options.copyrightText,scaleBarOptions:{metricUnit:"meters",metricLabel:"m",nonMetricUnit:"miles",nonMetricLabel:"mi"},legendOptions:{operationalLayers:f.slice()}},u.exportOptions={dpi:r,outputSize:[500,500]},JSON.stringify(u)}h();o.printProcess.empty().append('<p class="WaitMessage" style="text-align:center;"><\/p><div class="progress"><div class="WaitProgress progress-bar progress-bar-info active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"><\/div><\/div>');o.waitProgress=o.printProcess.find(".WaitProgress").eq(0);o.waitMessage=o.printProcess.find(".WaitMessage").eq(0);var e=l(n,t,r),s={Web_Map_as_JSON:e,Format:n.format,Layout_Template:n.layout};c.submitJob(s,function(n){c.getResultData(n.jobId,"Output_File",function(n){var e=n.value.url.toLowerCase().indexOf("/arcgis"),t=n.value.url.substring(e),i="",r;i=location.hostname=="localhost"?location.protocol+"//localhost"+t:location.protocol+"//"+location.host+t;r='<a href="'+i+'" class="btn btn-success btn-sm" target="_blank"><span class="glyphicon glyphicon-download-alt"><\/span> Download<\/a>';u(r,100,!1);f()},function(n){u('<div class="alert alert-danger" role="alert">'+n+"<\/div>",100,!0);f()})},function(n){switch(n.jobStatus){case"esriJobSubmitted":u('<div class="alert alert-info" role="alert">Avvio processo di esportazione...<\/div>',30,!1);break;case"esriJobExecuting":u('<div class="alert alert-info" role="alert">Esportazione...<\/div>',60,!1);break;case"esriJobSucceeded":u('<div class="alert alert-success" role="alert">Esportazione completata con successo...<\/div>',100,!1);break;case"esriJobFailed":u('<div class="alert alert-danger" role="alert">Esportazione fallita...<\/div>',100,!0)}},function(n){u('<div class="alert alert-danger" role="alert">'+n+"<\/div>",100,!0);f()})}var a=new t(o.exportMapGPServerURL,{async:!0}),c=new u(o.exportMapGPServerURL),h,f,s,l;if(h=e.filter(n.parameters,function(n){return n.name==="Layout_Template"}),h.length===0){console.log('print service parameters name for templates must be "Layout_Template"');return}f=h[0].choiceList;s=e.indexOf(f,"MAP_ONLY");s>-1&&(l=f.splice(s,s+1)[0],f.push(l));e.forEach(f,function(n){o.printOptionsLayoutTemplate.append($("<option>").val(n).text(n))});o.printOptionsTitle.val("");o.printBtn.click(function(){var u=o.printOptionsLayoutTemplate.find("option:selected").val(),n=new r,t,i;n.layout=n.label=u;n.format="PDF";t=o.printOptionsTitle.val();i=o.printOptionsDpi.val();v(n,t,i)})}function c(n){console.log("Something broke: ",n)}this.exportMapGPServerURL="";this.printOptionsTitle=null;this.printOptionsDpi=null;this.printOptionsLayoutTemplate=null;this.printBtn=null;this.printProcess=null;this.waitMessage=null;this.waitProgress=null;this.legendLayerIds=[];this.options={authorText:"",copyrightText:""};var o=this;return{startup:function(t,i,r,u){o.legendLayerIds=i;o.options=u;o.exportMapGPServerURL=r;s(t);var f=n({url:r,content:{f:"pjson"}});f.then(h,c)}}});