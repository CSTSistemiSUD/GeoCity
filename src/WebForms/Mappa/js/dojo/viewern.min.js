define(["pkg/calcitemaps.min","pkg/identify.min","pkg/legend.min","pkg/print.min","pkg/export.min","pkg/fc_vincoli.min","pkg/fc_catasto.min","pkg/fc_base.min","pkg/sued.min","esri/request","esri/graphicsUtils","esri/urlUtils","esri/map","esri/toolbars/edit","esri/geometry/Extent","esri/geometry/scaleUtils","esri/tasks/locator","esri/tasks/QueryTask","esri/tasks/query","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/FeatureLayer","esri/layers/ImageParameters","esri/InfoTemplate","esri/dijit/Search","esri/dijit/Legend","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","dojo/query","dojo/dom","dojo/on","dojo/dom-construct","dojo/i18n!esri/nls/jsapi","dojo/domReady!"],function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt,it,i,rt,ut,ft,et,ot,st,ht){function at(){function n(n){app.map.setExtent(app.map.extent.expand(n))}$("#zoomFull").click(function(){app.initialExtent&&app.map.setExtent(app.initialExtent)});$("#zoomIn").click(function(){n(.5)});$("#zoomOut").click(function(){n(1.5)});$(document).on("change",".select-all-feature",function(){$(".select-feature").prop("checked",$(this).prop("checked"))});$(document).on("click",".select-feature, .zoom-feature",function(){var n=$(this).attr("data-layer"),i=$(this).attr("data-objectid"),t=g.SELECTION_NEW;$(this).hasClass("select-feature")&&(t=$(this).prop("checked")?g.SELECTION_ADD:g.SELECTION_SUBTRACT);app.queryIds(n,i,t,!1,function(){app.zoomToSelectedFeatures(n)})});$(document).on("click",".btn-edit-position",function(){var n=$(this).attr("data-layer"),t=$(this).attr("data-objectid");app.activateToolbar(n,t)});$(document).on("click","button.zoom-coords",function(){var n=$(this).data("lng"),t=$(this).data("lat"),r=$(this).data("lod"),i=webMercatorUtils.geographicToWebMercator(new Point(n,t));app.map.centerAt(i)})}var ct=app_url+"/proxy/proxy.ashx",lt="http://localhost";return{startup:function(){if(_exception!="")return $("#mapViewDiv").append('<div class="alert alert-danger text-center" role="alert" style="margin:120px;"><h4>ERRORE DI INIZIALIZZAZIONE<\/h4><p>'+_exception+"<\/p><\/div>"),$("#loadingImg").hide(),!1;l.addProxyRule({urlPrefix:lt,proxyUrl:ct});app.ags_services_url=lt+"/arcgis/rest/services/";app.mapContainer=$("#mapContainer");app.map=new a("mapViewDiv",{logo:!1,slider:!1,showLabels:!0,scrollWheelZoom:!0,maxScale:200,minScale:1e5});app.mapServerUrl="";app.operationalMap=null;app.operationalMapLegend=null;app.editToolbar=null;app.mainToolbar="#mainToolbar";app.sidebarToolbar="#sidebarToolbar";app.panelContainer="#panelContainer";app.legend=null;app.dijitSearch=null;app.searchDiv="searchNavDiv";app.loading=ot.byId("loadingImg");app.initialExtent=null;app.editTypeEnum={Add:1,Edit:2,Delete:3};app.identifyConfig={Layer:null,LayerIds:[]};app.tools={IDENTIFY:"identify",SELECT:"select",ADD_POINT:"add_point"};app.activeTool=app.tools.IDENTIFY;app.currentEditingLayer=null;app.enumLayers={PARTICELLE:{name:"PARTICELLE",id:-1},FABBRICATI:{name:"FABBRICATI",id:-1},EDIFICI:{name:"EDIFICI",id:-1},VINCOLI:{name:"TEMATISMI",id:-1},SUED:{name:"SUED",id:-1},GRAFO:{name:"STRADE",id:-1},CIVICI:{name:"NUMERAZIONE CIVICA",id:-1},BASE:{name:"BASE",id:-1}};app.visibleLayers=[];app.visibleLayersBase=[];app.visibleLayersVincoli=[];app.showLoading=function(){esri.show(app.loading);app.map.disableMapNavigation();app.map.hideZoomSlider()};app.hideLoading=function(){esri.hide(app.loading);app.map.enableMapNavigation();app.map.showZoomSlider()};app.log=function(n){$("#logDiv").html(n)};app.createDynamicLayer=function(n,t,i){var r=new nt,u;r.format="png32 ";r.transparent=!0;u=new d(n,{id:t,imageParameters:r});u.on("load",i);u.on("error",function(t){t.error.message!=="Request canceled"&&(alert("Impossibile caricare il servizio:\n"+n+"\n"+t.error),console.log(n))})};app.calculateDefaultFullExtent=function(n,t){var r=new esri.tasks.QueryTask(n.url),i=new esri.tasks.Query;i.returnGeometry=!0;i.outFields=["*"];i.where=n.defQuery;r.execute(i,function(n){if(n.features.length>0){dojo.forEach(n.features,function(n){app.initialExtent=app.initialExtent===null?n.geometry.getExtent():app.initialExtent.union(n.geometry.getExtent())});app.initialExtent=app.initialExtent.expand(2);var i=app.map.setExtent(app.initialExtent);i.then(function(){t()},function(){},function(){})}else t()})};app.getExtentForScale=function(n){return p.getExtentForScale(app.map,n)};app.zoomToScale=function(n){app.map.setExtent(p.getExtentForScale(app.map,n))};app.updateFeatureLayer=function(n,t,i,r){var f=app.map.getLayer(n),u;switch(i){case app.editTypeEnum.Add:u=f.applyEdits([t],null,null);break;case app.editTypeEnum.Edit:u=f.applyEdits(null,[t],null);break;case app.editTypeEnum.Delete:u=f.applyEdits(null,null,[t])}u.then(function(n,u,f){var e,s="",o,h;switch(i){case app.editTypeEnum.Add:e=n.slice();break;case app.editTypeEnum.Edit:e=u.slice();break;case app.editTypeEnum.Delete:e=f.slice()}for(o=0;o<e.length;o++)h=e[o],h.success===!1&&(s+=h.error.message+"\n");s!==""?BootstrapDialog.alert({title:"ERRORE",message:s,type:BootstrapDialog.TYPE_DANGER}):$.isFunction(r)&&r(t)},function(n){BootstrapDialog.alert({title:"ERRORE",message:n.message+"\nError Code: "+n.code,type:BootstrapDialog.TYPE_DANGER})})};app.getLayerAttributes=function(n){var i=app.map.getLayer(n),t;if(isEmpty(i)){alertDanger("Livello "+n+" non valido.\nSe il problema persiste, ricaricare la pagina (CTRL+F5).");return}return t={},dojo.forEach(i.fields,function(n){t[n.name]=null}),t};app.queryFeatures=function(n,t,i){app.showLoading();var u=new esri.tasks.QueryTask(app.operationalMap.url+"/"+n),r=new k;r.where=t;r.returnGeometry=!0;u.execute(r,function(n){app.hideLoading();n.features.length==0?alertWarning('<p style="font-size:10pt;">La ricerca per <strong>"'+t+'"<\/strong>, non ha prodotto risultati!<\/p>'):i(n.features)},function(n){app.hideLoading();console.log(n)})};app.queryIds=function(n,t,i){var u=new esri.tasks.QueryTask(app.operationalMap.url+"/"+n),r=new k;r.objectIds=t.slice();r.outFields=["*"];r.returnGeometry=!0;u.execute(r,function(n){i(n.features)})};app.selectFeatures=function(n,t,i,r){var u=app.map.getLayer(n);u.selectFeatures(t,i,function(n){r(n)})};app.zoomToSelectedFeatures=function(n){var t=app.map.getLayer(n);app.zoomToFeatures(t.geometryType,t.getSelectedFeatures())};app.zoomToFeatures=function(n,t){t.length>0&&(n=="esriGeometryPoint"&&t.length==1?app.map.setExtent(app.createExtentAroundAPoint(t[0].geometry,5,5)):app.map.setExtent(c.graphicsExtent(t).expand(2)))};app.createExtentAroundAPoint=function(n,t,i){return new y(n.x-t,n.y-i,n.x+t,n.y+i,n.spatialReference)};app.activateToolbar=function(n,t){if(app.editToolbar===null){app.editToolbar=new v(app.map);app.editToolbar.on("graphic-move-stop",function(){app.currentEditingLayer.clearSelection();app.editToolbar.deactivate()});app.editToolbar.on("deactivate",function(n){n.info.isModified&&(app.map.infoWindow.hide(),$.isFunction(app.checkPosition)&&app.checkPosition(n.graphic,!1))})}app.map.infoWindow.hide();app.currentEditingLayer=app.map.getLayer(n);app.currentEditingLayer.clearSelection();app.queryIds(n,t,g.SELECTION_NEW,!0,function(n){var i,t,r;n.length>0&&(i=n[0],t=0,t=t|v.MOVE,r={},app.editToolbar.activate(t,i,r))})};app.highlightGraphic=function(n,t){var i=null,r,u;for(app.map.infoWindow.hide(),r=0;r<t.length;r++)i=t[r],n===i.attributes.OBJECTID&&(r=t.length,u=app.map.centerAt(i.geometry),u.then(function(){app.map.infoWindow.clearFeatures();app.map.infoWindow.setFeatures([i]);app.map.infoWindow.show(i.geometry)},function(){},function(){}))};app.highlightFeatures=function(n){var i,r,t,u;for(app.map.graphics.clear(),i=0;i<n.length;i++)r=n[0].geometry,t=new esri.Graphic(r),r.type=="point"?(u=new SimpleMarkerSymbol(app.map.infoWindow.markerSymbol.toJson()),u.setSize(48),t.setSymbol(u)):t.setSymbol(app.map.infoWindow.fillSymbol),app.map.graphics.add(t)};app.closeAllSidebar=function(){$("div.sidebar").each(function(){$(this).data("bs.sidebar")&&$(this).data("bs.sidebar").hide()})};app.showInfoWithToolbar=function(n,t,i,r,u,f,e,o){var s=ht.create("div",{className:"btn-group pull-right",role:"group"}),h=ht.create("div"),v=ht.toDom('<div style="max-height:200px; overflow:auto;"><\/div>'),y=ht.toDom("<div><\/div>"),c,l,a;$.isFunction(u)&&(c=ht.create("a",{href:"#",title:"Modifica",className:"btn btn-default btn-sm",innerHTML:'<span class="glyphicon glyphicon-pencil"><\/span>'}),st(c,"click",function(){u(t)}),ht.place(c,s));f&&(l=ht.create("a",{href:"#",title:"Sposta",className:"btn btn-default btn-sm",innerHTML:'<span class="glyphicon glyphicon-move"><\/span>'}),st(l,"click",function(){app.activateToolbar(n,t.attributes.OBJECTID)}),ht.place(l,s));e&&(a=ht.create("a",{href:"#",title:"Elimina",className:"btn btn-default btn-sm",innerHTML:'<span class="glyphicon glyphicon-trash"><\/span>'}),st(a,"click",function(){BootstrapDialog.confirm({title:"CONFERMA",message:"Eliminare questo elemento?",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"Annulla",btnOKLabel:"Ok!",btnOKClass:"btn-warning",callback:function(i){i&&(app.map.infoWindow.hide(),app.updateFeatureLayer(n,t,app.editTypeEnum.Delete,function(){app.operationalMap.refresh()}))}})}),ht.place(a,s));ht.place(s,y);ht.place(v,h);ht.place(dojo.toDom(r),v);ht.place(ht.create("hr"),h);ht.place(y,h);app.map.infoWindow.setTitle(i);app.map.infoWindow.setContent(h);app.map.infoWindow.show(o.mapPoint)};app.initSearch=function(n,t){app.dijitSearch=new it({map:app.map,enableHighlight:!1,showInfoWindowOnSelect:!0,sources:n.slice(),allPlaceholder:t},app.searchDiv);app.dijitSearch.startup();app.dijitSearch.on("select-result",function(n){app.zoomToFeatures(n.result.feature._layer.geometryType,[n.result.feature])})};app.loadLegend=function(n){$.getJSON(n,{},function(n){app.operationalMapLegend=n})};app.getLayerLegend=function(n){var t;return $.each(app.operationalMapLegend.layers,function(i,r){if(r.layerId==n)return t=r.legend.slice(),!1}),t};app.getInfoTemplate=function(n,t){switch(n.toUpperCase()){case app.enumLayers.GRAFO.name:return new tt(n.toUpperCase(),"Toponimo: ${LABEL}");case app.enumLayers.CIVICI.name:return new tt(n.toUpperCase(),"INDIRIZZO: ${INDIRIZZO}<br/>OCCUPANTE: ${OCCUPANTE_}<br/>PROPRIETARIO: ${PROPRIET}");case app.enumLayers.PARTICELLE.name:case app.enumLayers.FABBRICATI.name:return _userType!=2?new tt(n.toUpperCase(),'COD. ${COMUNE} FG. ${FOGLIO} NUM. ${NUMERO}<br/><button type="button" class="btn btn-primary btn-xs btn-analizza-vincoli" data-oid="${OBJECTID}" data-livello="'+n.toUpperCase()+'" style="margin-top: 24px;">Analizza Vincoli<\/button>&nbsp;<button type="button" class="btn btn-primary btn-xs btn-info-catasto" data-terna="${COMUNE}|${FOGLIO}|${NUMERO}" data-livello="'+n.toUpperCase()+'" style="margin-top: 24px;">Info Catastali<\/button>&nbsp;<button type="button" class="btn btn-primary btn-xs btn-info-sued" data-terna="${COMUNE}|${FOGLIO}|${NUMERO}" data-livello="'+n.toUpperCase()+'" style="margin-top: 24px;">SUED<\/button>'):new tt(n.toUpperCase(),'COD. ${COMUNE} FG. ${FOGLIO} NUM. ${NUMERO}<br/><button type="button" class="btn btn-primary btn-xs btn-analizza-vincoli" data-oid="${OBJECTID}" data-livello="'+n.toUpperCase()+'" style="margin-top: 24px;">Analizza Vincoli<\/button>&nbsp;');case app.enumLayers.VINCOLI.name:return new tt("VINCOLI","Tipo vincolo: "+t+"<br />Rif. normativo: ${RIF_NORMATIVO}<br/>")}};app.init=function(){$("#TitleBar").html(_descrizione);var n="";app.mapServerUrl=app.ags_services_url+"/"+_servizio+"/MapServer";app.createDynamicLayer(app.mapServerUrl,"MainLayer",function(t){var i,r,u;for(at(),app.operationalMap=t.layer,app.identifyConfig.Layer=t.layer,app.visibleLayers=app.operationalMap.visibleLayers.slice(),i=[],r=app.operationalMap.layerInfos,u=0;u<r.length;u++){info=r[u];switch(info.name.toUpperCase()){case"CATASTO":_userType!=2&&e.inizializza();break;case app.enumLayers.PARTICELLE.name:case app.enumLayers.FABBRICATI.name:app.identifyConfig.LayerIds.push(info.id);n="CERCA FG/NUM";info.name.toUpperCase()==app.enumLayers.PARTICELLE.name&&i.push({featureLayer:new g(app.mapServerUrl+"/"+info.id,{outFields:["*"],infoTemplate:app.getInfoTemplate(info.name.toUpperCase())}),outFields:["OBJECTID","COMUNE","FOGLIO","NUMERO","RICERCA"],searchFields:["RICERCA"],maxSuggestions:6,displayField:"RICERCA",suggestionTemplate:"FG. ${FOGLIO} NUM. ${NUMERO}",name:info.name.toUpperCase(),placeholder:"CERCA FG/NUM "+info.name.toUpperCase(),enableSuggestions:!0,autoNavigate:!1});info.name.toUpperCase()==app.enumLayers.PARTICELLE.name&&(app.enumLayers.PARTICELLE.id=info.id);info.name.toUpperCase()==app.enumLayers.FABBRICATI.name&&(app.enumLayers.FABBRICATI.id=info.id);break;case app.enumLayers.VINCOLI.name:app.identifyConfig.LayerIds.push(info.id);app.visibleLayers.splice(app.visibleLayers.indexOf(info.id),1);app.enumLayers.VINCOLI.id=info.id;break;case app.enumLayers.BASE.name:app.visibleLayers.splice(app.visibleLayers.indexOf(info.id),1);app.enumLayers.BASE.id=info.id;break;case app.enumLayers.SUED.name:_userType!=2&&(app.visibleLayers.splice(app.visibleLayers.indexOf(info.id),1),app.enumLayers.SUED.id=info.id);break;case app.enumLayers.GRAFO.name:app.identifyConfig.LayerIds.push(info.id);info.name.toUpperCase()==app.enumLayers.GRAFO.name&&(app.enumLayers.GRAFO.id=info.id);n="CERCA STRADA";info.name.toUpperCase()==app.enumLayers.GRAFO.name&&i.push({featureLayer:new g(app.mapServerUrl+"/"+info.id,{outFields:["*"],infoTemplate:app.getInfoTemplate(info.name.toUpperCase())}),outFields:["OBJECTID","LABEL"],searchFields:["LABEL"],maxSuggestions:6,displayField:"LABEL",suggestionTemplate:"${LABEL}",name:info.name.toUpperCase(),placeholder:"CERCA STRADA "+info.name.toUpperCase(),enableSuggestions:!0,autoNavigate:!1});break;case app.enumLayers.CIVICI.name:app.identifyConfig.LayerIds.push(info.id);info.name.toUpperCase()==app.enumLayers.CIVICI.name&&(app.enumLayers.CIVICI.id=info.id);info.name.toUpperCase()==app.enumLayers.CIVICI.name&&(n="CERCA CIVICI",i.push({featureLayer:new g(app.mapServerUrl+"/"+info.id,{outFields:["*"],infoTemplate:app.getInfoTemplate(info.name.toUpperCase())}),outFields:["OBJECTID","INDIRIZZO","PROPRIET","OCCUPANTE_"],searchFields:["INDIRIZZO"],maxSuggestions:6,displayField:"INDIRIZZO",suggestionTemplate:"${INDIRIZZO}",name:"CIVICI",placeholder:"CERCA CIVICO "+info.name.toUpperCase(),enableSuggestions:!0,autoNavigate:!1}),n="CERCA UTENTI",i.push({featureLayer:new g(app.mapServerUrl+"/"+info.id,{outFields:["*"],infoTemplate:app.getInfoTemplate(info.name.toUpperCase())}),outFields:["OBJECTID","INDIRIZZO","PROPRIET","OCCUPANTE_"],searchFields:["PROPRIET","OCCUPANTE_"],maxSuggestions:6,displayField:"INDIRIZZO",suggestionTemplate:"PR. ${PROPRIET} OC. ${OCCUPANTE_}",name:"CIVICI",placeholder:"CERCA UTENTE "+info.name.toUpperCase(),enableSuggestions:!0,autoNavigate:!1}))}}i.length>0&&app.initSearch(i,n);app.enumLayers.VINCOLI.id!=-1&&f.inizializza(app.enumLayers.VINCOLI.id,r);app.enumLayers.BASE.id!=-1&&o.inizializza(app.enumLayers.BASE.id,r);app.enumLayers.SUED.id!=-1&&s.inizializza(app.enumLayers.SUED.id,r);app.map.addLayers([t.layer])})};app.map.on("click",function(n){switch(app.activeTool){case app.tools.IDENTIFY:t.executeIdentifyTask(n,app.identifyConfig.Layer,app.identifyConfig.LayerIds,function(t){app.map.infoWindow.setFeatures(t);app.map.infoWindow.show(n.mapPoint)})}});app.map.on("update-start",app.showLoading);app.map.on("update-end",app.hideLoading);app.map.on("layers-add-result",function(){app.initialExtent=app.map.extent;$(app.sidebarToolbar).append($("#tmplPanelButton").render({Id:"Legenda",Title:"Legenda",Icon:"glyphicon glyphicon-th-list"}));$(app.panelContainer).append($("#tmplPanel").render({Id:"Legenda",Title:"Legenda",Icon:"glyphicon glyphicon-th-list"}));app.legend=new i({map:app.map},"panelContentLegenda");app.legend.startup();app.loadLegend(ct+"?"+app.mapServerUrl+"/legend?f=json");_particella_oid>0&&f.analizza(app.enumLayers.PARTICELLE,_particella_oid)});app.init()}}});