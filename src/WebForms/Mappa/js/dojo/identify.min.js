define(["esri/request","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/symbols/PictureMarkerSymbol","esri/graphic","dojo/on","dojo/dom-construct","dojo/_base/array","dojo/domReady!"],function(n,t,i,r,u,f,e,o){"use strict";function l(n,t){return t=isEmpty(t)?" ":t,isEmpty(n)?t:n}var v,s,h,y,w=location.href.replace(/\/[^/]+$/,"/"),p=new r(w+"img/Location_marker_pin_map_gps.png",24,24),c,a;return p.setOffset(-2,8),c=new u(null,p),a=!1,{executeIdentifyTask:function(n,r,u,f){a&&(c.setGeometry(app.map.extent.getCenter()),c.hide(),app.map.graphics.add(c));y=r.url;v=new t(y);s=new i;s.returnGeometry=!0;s.layerOption=i.LAYER_OPTION_ALL;s.tolerance=5;s.width=app.map.width;s.height=app.map.height;s.layerIds=u;s.layerDefinitions=r.layerDefinitions.slice();s.geometry=n.mapPoint;s.mapExtent=app.map.extent;v.execute(s,function(t){if(h=[],h=o.map(t,function(n){var i=n.feature,t=n.layerName;return i.attributes.layerName=t,app.visibleLayersVincoli.indexOf(n.layerId)>-1||app.visibleLayersBase.indexOf(n.layerId)>-1||app.visibleLayers.indexOf(n.layerId)>-1||t==="Fabbricati"||t==="Particelle"?(n.layerId>10&&t!=="Fabbricati"&&t!=="Particelle"?i.setInfoTemplate(app.getInfoTemplate("TEMATISMI",t)):i.setInfoTemplate(app.getInfoTemplate(t,t)),i):void 0}),h=h.filter(function(n){return n!==undefined}),t.length>0){var i=app.map.centerAt(app.map.toMap(n.screenPoint));a&&(c.setGeometry(app.map.toMap(n.screenPoint)),c.show());i.then(function(){f(h,n)},function(){},function(){})}})}}});