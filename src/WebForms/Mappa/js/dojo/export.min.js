define([],function(){"use strict";function n(n){var t={ERROR_MESSAGE:n.href,EXPORTED_IMAGE:"",MAP_SCALE:0},i,r;return n.href.indexOf("Error")<0&&(t.ERROR_MESSAGE="",n.href.lastIndexOf("/")!=-1&&(i=n.href.lastIndexOf("/")+1,r=n.href.length,t.EXPORTED_IMAGE=n.href.substring(i,r),t.MAP_SCALE=Math.ceil(n.scale))),t}function t(n,t,i){var a=i/2.54*100,y=n/2/a,p=t/2/a,r=app.map.extent.xmax,o=app.map.extent.xmin,u=app.map.extent.ymax,s=app.map.extent.ymin,h=r-(r-o)/2,c=u-(u-s)/2,v=esri.geometry.getScale(app.map),f,e,l;return r=v*y+h,u=v*p+c,o=h-(r-h),s=c-(u-c),f=new esri.geometry.Multipoint,e=new esri.geometry.Point(o,s,new esri.SpatialReference({wkid:app.map.spatialReference.wkid})),f.addPoint(e),e=new esri.geometry.Point(r,u,new esri.SpatialReference({wkid:app.map.spatialReference.wkid})),f.addPoint(e),l=f.getExtent(),l.setSpatialReference(app.map.spatialReference),l}app.exportExtent={CURRENT_EXTENT:"CURRENT_EXTENT",CURRENT_SCALE:"CURRENT_SCALE"};app.isBaseMapPlanLoaded=function(){return!1};app.getPageSize=function(n,t){var i="",r="",u=0,f=0;return i=n[0],u=n[1],f=n[2],r=n[3],{Id:i,Xmm:u,Ymm:f,Orientation:r,FileName:t}};app.exportLayoutClient=function(i,r,u,f){var o=r.Xmm,s=r.Ymm,h=o/25.4*u,c=s/25.4*u,l=Math.round(h),a=Math.round(c),e=new esri.layers.ImageParameters,v;e.width=l;e.height=a;e.bbox=i==app.exportExtent.CURRENT_EXTENT?map.extent:t(e.width,e.height,u);e.format="png8";e.transparent=!0;e.dpi=u;e.layerDefinitions=app.operationalMap.layerDefinitions==null?[]:app.operationalMap.layerDefinitions.slice();e.layerIds=app.operationalMap.visibleLayers.slice();e.layerOption=esri.layers.ImageParameters.LAYER_OPTION_SHOW;v="";app.operationalMap.exportMapImage(e,function(t){var i=n(t,r.Id,r.Orientation),u;i.ERROR_MESSAGE==""&&app.isBaseMapPlanLoaded()&&(u=new esri.layers.ImageParameters,u.width=e.width,u.height=e.height,u.bbox=e.bbox,u.format=e.format,u.dpi=e.dpi,basemapPlan.exportMapImage(u,function(t){var u=n(t,r.Id,r.Orientation);u.ERROR_MESSAGE==""?dojo.xhrPost({url:_dbServiceUrl+"/CombineMapImage",handleAs:"text",headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:1e5,postData:dojo.toJson({tiledMapImageName:u.EXPORTED_IMAGE,baseMapImageName:i.EXPORTED_IMAGE}),load:function(n){i.EXPORTED_IMAGE=dojo.fromJson(n).d;i.DOWNLOAD_LINK=getDownloadLink(i.EXPORTED_IMAGE,i.MAP_SCALE,r.Id,r.Orientation)},error:function(n){i.ERROR_MESSAGE==n},handle:function(){f(i)}}):f(i)}));app.isBaseMapPlanLoaded()&&i.ERROR_MESSAGE==""||f(i)})}});