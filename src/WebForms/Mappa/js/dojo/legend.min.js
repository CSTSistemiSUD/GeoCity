define(["esri/request","dojo/domReady!"],function(n){"use strict";function e(n,f){var o=$("<li>"),s,h;return n.subLayerIds?(o.append('<input type="checkbox" class="chk-legend-item chk-group-layer">&nbsp;').append('<span class="'+r+'"><\/span>&nbsp;<a href="#" class="legend-item" data-state="closed">'+n.name+" [Gruppo]<\/a>"),s=$('<ul style="display:none;">'),$.each(n.subLayerIds,function(n,r){var f=u.layerInfos[r];s.append(e(f,i[f.id]));t=f.id}),o.append(s)):(o.append('<input type="checkbox" '+(n.defaultVisibility?"checked=checked":"")+' value="'+n.id+'" class="chk-legend-item chk-layer">&nbsp;').append('<span class="'+r+'"><\/span>&nbsp;<a href="#" class="legend-item" data-state="closed">'+n.name+"<\/a>"),h=$('<ul style="display:none;">'),$.each(f,function(n,t){h.append('<li><img alt="'+t.label+'" src="data:'+t.contentType+";base64,"+t.imageData+'" height="'+t.height+'" width="'+t.width+'">&nbsp;'+t.label+"<\/li>")}),o.append(h)),o}function s(){var n=[];$(".chk-layer:checked").each(function(t,i){n.push($(i).attr("value"))});n.length===0&&n.push(-1);u.setVisibleLayers(n)}function o(n){function r(n){var i=n.parent().parent(),u=!0;n.siblings().each(function(){return u=$(this).children('input[type="checkbox"]').prop("checked")===t});u&&t?(i.children('input[type="checkbox"]').prop({indeterminate:!1,checked:t}),r(i)):u&&!t?(i.children('input[type="checkbox"]').prop("checked",t),i.children('input[type="checkbox"]').prop("indeterminate",i.find('input[type="checkbox"]:checked').length>0),r(i)):n.parents("li").children('input[type="checkbox"]').prop({indeterminate:!0,checked:!1})}var t=$(n).prop("checked"),i=$(n).parent(),u=i.siblings();i.find('input[type="checkbox"]').prop({indeterminate:!1,checked:t});r(i)}function h(n){var t=$(n).closest("li").children("ul").find("input:checkbox");t.length>0&&o(t[0])}var u,f="glyphicon glyphicon-triangle-bottom",r="glyphicon glyphicon-triangle-right",t=0,i=[];$(document).on("click","a.legend-item",function(n){n.stopPropagation();var t=$(this);$(this).closest("li").children("ul").slideToggle(function(){t.data("state")=="opened"?(t.data("state","closed"),t.prev("span").removeClass(f).addClass(r)):(t.data("state","opened"),t.prev("span").removeClass(r).addClass(f))})});$(document).on("change",".chk-legend-item",function(){o(this);s()});return{build:function(r,f){t=0;i=[];$(f).addClass("legend-container");u=r;var o=n({url:r.url+"/legend",content:{f:"pjson"},handleAs:"json",callbackParamName:"callback"});o.then(function(n){var u,o,s;for($.each(n.layers,function(n,t){i[t.layerId]=[];$.each(t.legend,function(n,r){i[t.layerId].push(r)})}),u=$('<ul class="legend-tree">'),t=0;t<r.layerInfos.length;t++)o=r.layerInfos[t],s=e(o,i[o.id]),u.append(s);$(f).empty().append(u);$(".chk-group-layer",u).each(function(n,t){h(t)})},function(n){alert(n)})}}});